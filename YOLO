import csv
from operator import index #Ler arquivos em formato CSV
import cv2 #OpenCV Visão Computacional
import numpy as np
from torch import classes #Biblioteca para computação científica

#Carregar o modelo YOLOv3 com pesos e configuração usando os arquvos "yolov3.weights" e "yolov3.cfg"
net = cv2.dnn.readNet("yolov3-tiny.weights", "yolov3-tiny.cfg") 

#Definir o backend para OpenCV e o alvo para CPU
net.setPreferableBackend(cv2.dnn.DNN_BACKEND_OPENCV) 
net.setPreferableTarget(cv2.dnn.DNN_TARGET_CPU) 

layer_names = net.getUnconnectedOutLayersNames() 

cap = cv2.VideoCapture(0) 
_, frame = cap.read()
height, width, _ = frame.shape

while True:

    
    blob = cv2.dnn.blobFromImage(frame, 1/255.0, (416, 416), swapRB=True, crop=False) 
    net.setInput(blob) #Definir a entrada para a rede neural

    outs= net.forward(layer_names) #Obter as saídas da rede neural

    #informações de detecção
    class_ids = []
    confidences = []
    boxes = []

    indexes = cv2.dnn.NMSBoxes(boxes, confidences, 0.5, 0.4) #deletar as caixas de detecção que se sobrepõem e manter apenas a caixa com a maior confiança

    for out in outs:
        for detection in out:
            scores = detection[5:]
            class_id = np.argmax(scores) #obter o índice da classe com a maior pontuação
            confidences.append(scores[class_id]) #adiciona a confiança da detecção
            if confidences[-1] > 0.5:
                center_x = int(detection[0] * width) #calcular as cordenadas X
                center_y = int(detection[1] * height) #calcular as cordenadas Y
                w = int(detection[2] * width)
                h = int(detection[3] * height)
                boxes.append([center_x, center_y, w, h])
                class_ids.append(class_id)

    #desenhar as caixas de detecção e os rótulos nas imagens
    for i in range(len(boxes)): 
        if len(indexes) > 0 and i in np.array(indexes).flatten():
            x, y, w, h = boxes[i]
            label = str(class_ids[i])
            confidence = confidences[i]

            color = (0, 255, 0)

            cv2.rectangle(frame, (x, y), (x + w, y + h), color, 2)
            cv2.putText(frame, label + " " + str(round(confidence, 2)),
                        (x, y - 10),
                        cv2.FONT_HERSHEY_SIMPLEX,
                        0.5,
                        color,
                        2)
        cv2.imshow("Image", frame)
    
        key = cv2.waitKey(1)
        if key == 27: #Pressionar a tecla "ESC" para sair
            break
    
    cap.release()
    cv2.destroyAllWindows() 